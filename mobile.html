<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.3 at Oct 9, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Sites GST: Site Foundation - </title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20121009" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Sites GST: Site Foundation
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
            
                <div class="xleft">
        <span id="publishDate">Last Published: 2012-10-09</span>
                  &nbsp;| <span id="projectVersion">Version: 11.6.0-SNAPSHOT</span>
                      </div>
            <div class="xright">        
            
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
            
                                <h5>Overview</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Introduction">Introduction</a>
            </li>
                  <li class="none">
                          <a href="new-features-11g.html" title="What is new in 11g">What is new in 11g</a>
            </li>
                  <li class="none">
                          <a href="InstallGuide.html" title="Installation">Installation</a>
            </li>
                  <li class="none">
                          <a href="action/index.html" title="MVC/Groovy support">MVC/Groovy support</a>
            </li>
                  <li class="none">
            <strong>Mobile</strong>
          </li>
                  <li class="none">
                          <a href="samples.html" title="Sample code/projects">Sample code/projects</a>
            </li>
                  <li class="none">
                          <a href="variables.html" title="Standard Variables">Standard Variables</a>
            </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="JavaDocs">JavaDocs</a>
            </li>
                  <li class="none">
                          <a href="gsf-taglib/tagreference.html" title="JSP tags">JSP tags</a>
            </li>
          </ul>
                       <h5>Modules</h5>
                  <ul>
                  <li class="none">
                          <a href="gsf-facades/index.html" title="Facades">Facades</a>
            </li>
                  <li class="none">
                          <a href="gsf-groovy/index.html" title="Groovy">Groovy</a>
            </li>
                  <li class="none">
                          <a href="gsf-action/index.html" title="Actions">Actions</a>
            </li>
                  <li class="none">
                          <a href="gsf-taglib/index.html" title="JSP taglib">JSP taglib</a>
            </li>
                  <li class="none">
                          <a href="gsf-wra/index.html" title="WRA">WRA</a>
            </li>
                  <li class="none">
                          <a href="gsf-tagging/index.html" title="Tagging">Tagging</a>
            </li>
                  <li class="none">
                          <a href="gsf-cs-test/index.html" title="Testing">Testing</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                                                                                <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                        <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
            
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!--  --><!-- Copyright 2012 Oracle Corporation. All Rights Reserved. --><!--  --><!-- Licensed under the Apache License, Version 2.0 (the "License"); --><!-- you may not use this file except in compliance with the License. --><!-- You may obtain a copy of the License at --><!--  --><!-- http://www.apache.org/licenses/LICENSE-2.0 --><!--  --><!-- Unless required by applicable law or agreed to in writing, software --><!-- distributed under the License is distributed on an "AS IS" BASIS, --><!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. --><!-- See the License for the specific language governing permissions and --><!-- limitations under the License. --><!--  --><div class="section"><h2>GST Site Foundation Mobile<a name="GST_Site_Foundation_Mobile"></a></h2><p>The mobile project helps to build multi-device websites on a single infrastructure Sites. It allows for editors to select a single layout (template) for an asset, and gives a developer the control to build device-specific Templates if needed. This can be used in conjunction with Responsive Design techniques. </p><p>The basic premise here is that the device specific parts of the website can be grouped at a high level, either for a desktop, a mobile or a tablet. The consequence is that device detection can be grouped into 3 families. The idea is that an editor selects a generic LayoutTemplate and that a developer implements device specific templates, LayoutTemplate_desktop, LayoutTemplate_mobile and LayoutTemplate_tablet. If a device-specific template is not found the original template will be used.</p><p>The algorithm used for the device detection is from mobiforge's <a class="externalLink" href="http://mobiforge.com/developing/story/lightweight-device-detection-php">PHP implementatation</a>. Other implementation might use WURFL or you can roll your own.</p><p>In device specific template you can do your device specific code, like</p><ul><li>load the navigation tree for mobile sites</li><li>load additional javascript for mobile or tablet, or use that big script just for desktop browsers.</li><li>load specific style sheets that cannot be handled through Responsive Design techniques.</li><li>Load device specific content, beyond just device specific formatting.</li></ul><p>The idea is that within the same editorial site content for specific devices can be managed.</p><p>Below is an Action that renders a page for a specific device based on 'normal' GSF dispatching rules. This Action is to be used in a Controller (ie Wrapper/Dispatcher). As you can see the implementation overwrites 3 methods of the RenderPageAction, one is to select to correct translation for the requested assets, and the other 2 to change the editor selected template to a device specific template. </p><div><pre>
package com.fatwire.gst.foundation.mobile.action;
/**
 * RenderPage action extension that handles translations as well as device
 * detection to direct the visitor to the device specific template. &lt;/p&gt; The
 * rule is straight forward. If the template is X then a lookup is done if there
 * is a Template with the name X_mobile and that is used if the visitor is using
 * a mobile device. The same for _desktop and _tablet. If such a template does
 * not exist, the 'normal' template is used. &lt;/p&gt;
 * 
 * 
 * @author Dolf Dijkstra
 * 
 */
public class DeviceAwareRenderPageAction extends RenderPage {

    @InjectForRequest
    public DeviceDetector detector;

    @InjectForRequest
    public LocaleService localeService;

    @Override
    protected AssetIdWithSite resolveAssetId() {
        return findTranslation(super.resolveAssetId());
    }

    @Override
    protected void callTemplate(AssetIdWithSite id, String tname) {
        DeviceType type = detector.detectDeviceType(ics);
        if (LOG.isDebugEnabled())
            LOG.debug(&quot;detected device type: &quot; + type);
        String dtname = checkForDeviceTName(id, tname, type);
        super.callTemplate(id, dtname);

    }

    @Override
    protected void callPage(AssetIdWithSite id, String pagename, String packedArgs) {
        DeviceType type = detector.detectDeviceType(ics);
        if (LOG.isDebugEnabled())
            LOG.debug(&quot;detected device type: &quot; + type);
        String nn = checkForDevicePagename(id, pagename, type);
        super.callPage(id, nn, packedArgs);
    }

    protected AssetIdWithSite findTranslation(AssetIdWithSite id) {
        AssetIdWithSite n = id;

        DimensionFilterInstance df = localeService.getDimensionFilter(id.getSite());
        if (df != null) {
            AssetId translated = localeService.findTranslation(id, df);
            if (translated != null)
                n = new AssetIdWithSite(translated, id.getSite());

        }
        return n;
    }

    protected String getPostfix(DeviceType type) {
        switch (type) {
            case MOBILE:
                return &quot;_mobile&quot;;
            case TABLET:
                return &quot;_tablet&quot;;
            default:
                return &quot;_desktop&quot;;
        }

    }

    protected String checkForDeviceTName(AssetIdWithSite id, String tname, DeviceType type) {
        if (StringUtils.endsWith(tname, &quot;_mobile&quot;) || StringUtils.endsWith(tname, &quot;_tablet&quot;)
                || StringUtils.endsWith(tname, &quot;_desktop&quot;)) {
            return tname;
        }
        String pf = getPostfix(type);
        final String targetPagename = tname.startsWith(&quot;/&quot;) ? (id.getSite() + tname + pf) : (id.getSite() + &quot;/&quot;
                + id.getType() + &quot;/&quot; + tname + pf);
        try {
            if (ics.getPageData(targetPagename).isRegistered()) {
                return tname + pf;
            } else if (LOG.isTraceEnabled()) {
                log.trace(&quot;There is no special template for &quot; + type + &quot; at template &quot; + tname);
            }
        } catch (IllegalArgumentException e) {
            LOG.warn(e.getMessage());
            // ignore
        }

        return tname;
    }

    protected String checkForDevicePagename(AssetIdWithSite id, String pagename, DeviceType type) {
        if (StringUtils.endsWith(pagename, &quot;_mobile&quot;) || StringUtils.endsWith(pagename, &quot;_tablet&quot;)
                || StringUtils.endsWith(pagename, &quot;_desktop&quot;)) {
            return pagename;
        }
        String pf = getPostfix(type);
        final String targetPagename = pagename + pf;

        try {

            if (ics.getPageData(targetPagename).isRegistered()) {
                return targetPagename;
            } else if (LOG.isTraceEnabled()) {
                log.trace(&quot;There is no device specific pagename for &quot; + type + &quot; at page &quot; + pagename);
            }
        } catch (NullPointerException e) {
            // ignore
        } catch (IllegalArgumentException e) {
            LOG.warn(e.getMessage());
            // ignore
        }
        return pagename;
    }
}
</pre></div><p>The device detection service needs to be added to the ObjectFactory chain. This is done by adding (or modifying) the file WEB-INF/gsf-groovy/gsf/ObjectFactory.groovy with the content below.</p><div><pre>
package gsf

import COM.FutureTense.Interfaces.ICS

import com.fatwire.gst.foundation.controller.action.Factory
import com.fatwire.gst.foundation.mobile.DeviceDetector
import com.fatwire.gst.foundation.mobile.mobiforge.MobiForgeDeviceDetector
import com.fatwire.gst.foundation.controller.annotation.ServiceProducer

public class ObjectFactory {

  @ServiceProducer(cache = true)
  static DeviceDetector createDeviceDetector(ICS ics, Factory f){
     return new MobiForgeDeviceDetector()
  }
}


</pre></div></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2010-2012
                      Oracle Corporation.
            All Rights Reserved.      
            
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
